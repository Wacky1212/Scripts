
-- üîÅ –¶–ò–ö–õ–ò–ß–ù–´–ô –°–ö–†–ò–ü–¢: —Å—Ç–∞–≤–∏—Ç –∏ –∞–ø–≥—Ä–µ–π–¥–∏—Ç —é–Ω–∏—Ç—ã, –∑–∞—Ç–µ–º –∂–¥—ë—Ç –∫–Ω–æ–ø–∫—É Play Again –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å—ë

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local entityFolder = workspace:WaitForChild("Map"):WaitForChild("Entities")
local cash = player:WaitForChild("leaderstats"):WaitForChild("Cash")

-- üîß –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–æ
local function parseCash(val)
    val = tostring(val or "0"):gsub(",", "")
    if val:lower():find("k") then
        local num = tonumber(val:lower():gsub("k", ""))
        if num then return num * 1000 end
    end
    return tonumber(val)
end

-- üí∞ –û–∂–∏–¥–∞–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
local function waitForCash(amount)
    repeat wait(0.2) until parseCash(cash.Value) >= amount
end

-- üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —é–Ω–∏—Ç–∞
local function placeUnitAndGetId(unitName, position)
    local before = {}
    for _, v in pairs(entityFolder:GetChildren()) do before[v] = true end

    local cf = CFrame.new(position) * CFrame.Angles(0, math.rad(180), 0)
    ReplicatedStorage.RemoteFunctions.PlaceUnit:InvokeServer(unitName, {
        Valid = true,
        Position = position,
        CF = cf,
        Rotation = 180
    })

    for _ = 1, 50 do
        wait(0.1)
        for _, v in pairs(entityFolder:GetChildren()) do
            if not before[v] and v:IsA("Model") and v:GetAttribute("ID") then
                print("‚úÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω:", unitName)
                return v:GetAttribute("ID")
            end
        end
    end

    warn("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω:", unitName)
    return nil
end

-- üîÑ –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ ID —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö beehive —é–Ω–∏—Ç–æ–≤
local function getAllBeehiveIds()
    local ids = {}
    for _, unit in pairs(entityFolder:GetChildren()) do
        if unit:IsA("Model") and unit.Name == "unit_beehive" then
            local id = unit:GetAttribute("ID")
            if id then table.insert(ids, id) end
        end
    end
    return ids
end

-- ‚¨ÜÔ∏è –ê–ø–≥—Ä–µ–π–¥ —é–Ω–∏—Ç–∞ –ø–æ —à–∞–≥–∞–º
local function upgradeAtCash(unitId, upgradeSteps)
    for i, target in ipairs(upgradeSteps) do
        waitForCash(target)
        ReplicatedStorage.RemoteFunctions.UpgradeUnit:InvokeServer(unitId)
        print("‚¨ÜÔ∏è –ê–ø–≥—Ä–µ–π–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:", unitId, "–∑–∞", target)
    end
end

-- üß† –ê–≤—Ç–æ–≤—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ UI
local function autoVoteDifficulty(mode)
    local difficultyMap = {
        ["Easy"] = "dif_easy",
        ["Normal"] = "dif_normal",
        ["Hard"] = "dif_hard",
        ["Insane"] = "dif_insane",
        ["Impossible"] = "dif_impossible"
    }

    local arg = difficultyMap[mode or "Insane"] or "dif_insane"

    local PlayerGui = player:WaitForChild("PlayerGui")
    local voteUI = PlayerGui:WaitForChild("GameGui"):WaitForChild("Screen")
        :WaitForChild("Middle"):WaitForChild("DifficultyVote")

    task.spawn(function()
        while true do
            wait(0.2)
            if voteUI.Visible then
                print("üéØ –ì–æ–ª–æ—Å—É–µ–º –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:", arg)
                local success, result = pcall(function()
                    return ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer(arg)
                end)
                if success then
                    print("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ:", mode)
                else
                    warn("‚ùå –û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:", result)
                end
                break
            end
        end
    end)
end

-- üîÅ –¶–∏–∫–ª –æ–¥–∏–Ω–æ—á–Ω–æ–π –∫–∞—Ç–∫–∏
local function runMatch()
    wait(1)
    ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
    autoVoteDifficulty("Insane")
    wait(1)

    -- 1-3: unit_farmer_npc
    waitForCash(200)
    local id1 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-332.14, 63.38, -77.40))
    if id1 then upgradeAtCash(id1, {250, 350, 500}) end

    waitForCash(200)
    local id2 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-338.47, 63.38, -77.79))
    if id2 then upgradeAtCash(id2, {250, 350, 500}) end

    waitForCash(200)
    local id3 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-338.30, 63.38, -83.23))
    if id3 then upgradeAtCash(id3, {250, 350, 500}) end

    -- 4: —Å—Ç–∞–≤–∏–º –∏ —Å—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –∞–ø–≥—Ä–µ–π–¥–∏—Ç—å
    waitForCash(2500)
    local id4 = placeUnitAndGetId("unit_beehive", Vector3.new(-347.60, 63.46, -102.61))
    local beforeIds = getAllBeehiveIds()

    if id4 then
        waitForCash(1500)
        ReplicatedStorage.RemoteFunctions.UpgradeUnit:InvokeServer(id4)
        print("‚¨ÜÔ∏è –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –∞–ø–≥—Ä–µ–π–¥–∞:", id4)
        wait(1)

        local afterIds = getAllBeehiveIds()
        local foundOtherId = nil
        for _, id in ipairs(afterIds) do
            local isNew = true
            for _, old in ipairs(beforeIds) do
                if old == id then isNew = false break end
            end
            if isNew then
                foundOtherId = id
                break
            end
        end

        local finalId = foundOtherId or id4
        if finalId ~= id4 then
            print("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥—Ä—É–≥–æ–π ID:", finalId)
        end

        upgradeAtCash(finalId, {4000, 10000, 25000})
    end

    -- 5 –∏ 6: –æ–±—ã—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∞–ø–≥—Ä–µ–π–¥
    waitForCash(2500)
    local id5 = placeUnitAndGetId("unit_beehive", Vector3.new(-323.65, 63.46, -98.40))
    if id5 then upgradeAtCash(id5, {1500, 4000, 10000, 25000}) end

    waitForCash(2500)
    local id6 = placeUnitAndGetId("unit_beehive", Vector3.new(-324.86, 63.46, -91.45))
    if id6 then upgradeAtCash(id6, {1500, 4000, 10000, 25000}) end
end

-- üîÅ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ Play Again –∏ —Ä–µ—Å—Ç–∞—Ä—Ç
local function waitForPlayAgainButton()
    print("üîÑ –ñ–¥—ë–º –∫–Ω–æ–ø–∫—É Play Again...")
    local gui = player:WaitForChild("PlayerGui")
    while true do
        wait(0.5)
        local btn = gui:FindFirstChild("GameGui")
        and gui.GameGui:FindFirstChild("Screen")
        and gui.GameGui.Screen:FindFirstChild("Middle")
        and gui.GameGui.Screen.Middle:FindFirstChild("GameEnd")
        and gui.GameGui.Screen.Middle.GameEnd:FindFirstChild("Items")
        and gui.GameGui.Screen.Middle.GameEnd.Items:FindFirstChild("Frame")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame:FindFirstChild("Actions")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions:FindFirstChild("Items")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items:FindFirstChild("Again")

        if btn and btn.Visible then
            print("‚úÖ Play Again –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Ä–µ—Å—Ç–∞—Ä—Ç...")
            ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
            break
        end
    end
end

-- üöÄ –ó–ê–ü–£–°–ö –¶–ò–ö–õ–ê
while true do
    runMatch()
    waitForPlayAgainButton()
end
