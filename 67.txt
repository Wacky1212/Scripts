-- üîÅ –¶–ò–ö–õ–ò–ß–ù–´–ô –°–ö–†–ò–ü–¢: —Å—Ç–∞–≤–∏—Ç –∏ –∞–ø–≥—Ä–µ–π–¥–∏—Ç —é–Ω–∏—Ç—ã, –∑–∞—Ç–µ–º –∂–¥—ë—Ç –∫–Ω–æ–ø–∫—É Play Again –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å—ë

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local entityFolder = workspace:WaitForChild("Map"):WaitForChild("Entities")
local cash = player:WaitForChild("leaderstats"):WaitForChild("Cash")

local restarting = false

-- üîß –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–æ (–Ω–∞–¥—ë–∂–Ω–æ)
local function parseCash(val)
    if not val then return 0 end
    val = tostring(val):gsub(",", "")
    if val:lower():find("k") then
        local num = tonumber(val:lower():gsub("k", ""))
        if num then return num * 1000 end
    end
    return tonumber(val) or 0
end

-- üí∞ –ñ–¥—ë–º –Ω—É–∂–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞
local function waitForCash(amount)
    repeat wait(0.2) until parseCash(cash.Value) >= amount or restarting
end

-- üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —é–Ω–∏—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –µ–≥–æ ID
local function placeUnitAndGetId(unitName, position)
    local before = {}
    for _, v in pairs(entityFolder:GetChildren()) do before[v] = true end

    local cf = CFrame.new(position) * CFrame.Angles(0, math.rad(180), 0)
    ReplicatedStorage.RemoteFunctions.PlaceUnit:InvokeServer(unitName, {
        Valid = true,
        Position = position,
        CF = cf,
        Rotation = 180
    })

    for _ = 1, 50 do
        wait(0.1)
        for _, v in pairs(entityFolder:GetChildren()) do
            if not before[v] and v:IsA("Model") and v:GetAttribute("ID") then
                print("‚úÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω:", unitName)
                return v:GetAttribute("ID")
            end
        end
    end

    warn("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω:", unitName)
    return nil
end

-- ‚¨ÜÔ∏è –ê–ø–≥—Ä–µ–π–¥ –ø–æ —ç—Ç–∞–ø–∞–º
local function upgradeAtCash(unitId, upgradeSteps)
    for _, cost in ipairs(upgradeSteps) do
        waitForCash(cost)
        if restarting then return end
        ReplicatedStorage.RemoteFunctions.UpgradeUnit:InvokeServer(unitId)
        print("‚¨ÜÔ∏è –ê–ø–≥—Ä–µ–π–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:", unitId, "–∑–∞", cost)
    end
end

-- üß† –ê–≤—Ç–æ–≤—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
local function autoVoteDifficulty(mode)
    local difficultyMap = {
        ["Easy"] = "dif_easy",
        ["Normal"] = "dif_normal",
        ["Hard"] = "dif_hard",
        ["Insane"] = "dif_insane",
        ["Impossible"] = "dif_impossible"
    }

    local arg = difficultyMap[mode or "Insane"] or "dif_insane"
    local PlayerGui = player:WaitForChild("PlayerGui")
    local voteUI = PlayerGui:WaitForChild("GameGui"):WaitForChild("Screen")
        :WaitForChild("Middle"):WaitForChild("DifficultyVote")

    task.spawn(function()
        while true do
            wait(0.2)
            if voteUI.Visible then
                print("üéØ –ì–æ–ª–æ—Å—É–µ–º –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:", arg)
                local success, result = pcall(function()
                    return ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer(arg)
                end)
                if success then
                    print("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ:", mode)
                else
                    warn("‚ùå –û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:", result)
                end
                break
            end
        end
    end)
end

-- üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "Play Again" –≤ –õ–Æ–ë–û–ô –º–æ–º–µ–Ω—Ç
task.spawn(function()
    local gui = player:WaitForChild("PlayerGui")
    while true do
        wait(1)
        local btn = gui:FindFirstChild("GameGui")
        and gui.GameGui:FindFirstChild("Screen")
        and gui.GameGui.Screen:FindFirstChild("Middle")
        and gui.GameGui.Screen.Middle:FindFirstChild("GameEnd")
        and gui.GameGui.Screen.Middle.GameEnd:FindFirstChild("Items")
        and gui.GameGui.Screen.Middle.GameEnd.Items:FindFirstChild("Frame")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame:FindFirstChild("Actions")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions:FindFirstChild("Items")
        and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items:FindFirstChild("Again")

        if btn and btn.Visible then
            print("‚ùó –û–ë–ù–ê–†–£–ñ–ï–ù–ê –ö–ù–û–ü–ö–ê PLAY AGAIN ‚Äî –∞–≤–∞—Ä–∏–π–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç...")
            restarting = true
            ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
        end
    end
end)

-- üîÅ –ö–∞—Ç–∫–∞
local function runMatch()
    print("üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –∫–∞—Ç–∫–∏ runMatch()...")
    wait(1)
    ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
    autoVoteDifficulty("Insane")
    wait(1)
    restarting = false

    -- 1-3: unit_farmer_npc
    waitForCash(200)
    if restarting then return end
    local id1 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-332.14, 63.38, -77.40))
    if id1 then upgradeAtCash(id1, {250, 350, 500}) end

    waitForCash(200)
    if restarting then return end
    local id2 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-338.47, 63.38, -77.79))
    if id2 then upgradeAtCash(id2, {250, 350, 500}) end

    waitForCash(200)
    if restarting then return end
    local id3 = placeUnitAndGetId("unit_farmer_npc", Vector3.new(-338.30, 63.38, -83.23))
    if id3 then upgradeAtCash(id3, {250, 350, 500}) end

    -- 4: beehive (–±–µ–∑ –∞–ø–≥—Ä–µ–π–¥–∞)
    waitForCash(2500)
    if restarting then return end
    placeUnitAndGetId("unit_beehive", Vector3.new(-330.08, 63.46, -99.32))

    -- 5-6 beehive c –ø–æ–ª–Ω—ã–º –∞–ø–≥—Ä–µ–π–¥–æ–º
    waitForCash(2500)
    if restarting then return end
    local id5 = placeUnitAndGetId("unit_beehive", Vector3.new(-323.65, 63.46, -98.40))
    if id5 then upgradeAtCash(id5, {1500, 4000, 10000, 25000}) end

    waitForCash(2500)
    if restarting then return end
    local id6 = placeUnitAndGetId("unit_beehive", Vector3.new(-324.86, 63.46, -91.45))
    if id6 then upgradeAtCash(id6, {1500, 4000, 10000, 25000}) end

    -- 7-9 pulse_plant
    local pulseSteps = {3000, 7500, 10000, 25000}

    waitForCash(5000)
    if restarting then return end
    local id7 = placeUnitAndGetId("unit_pulse_plant", Vector3.new(-325.80, 63.94, -78.21))
    if id7 then upgradeAtCash(id7, pulseSteps) end

    waitForCash(5000)
    if restarting then return end
    local id8 = placeUnitAndGetId("unit_pulse_plant", Vector3.new(-328.13, 63.94, -85.03))
    if id8 then upgradeAtCash(id8, pulseSteps) end

    waitForCash(5000)
    if restarting then return end
    local id9 = placeUnitAndGetId("unit_pulse_plant", Vector3.new(-340.26, 63.94, -88.00))
    if id9 then upgradeAtCash(id9, pulseSteps) end
end

-- üöÄ –ì–ª–∞–≤–Ω—ã–π –¶–ò–ö–õ
while true do
    restarting = false
    runMatch()
end
