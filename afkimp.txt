-- üîÅ –ü–†–û–°–¢–û–ô –ê–í–¢–û–§–ê–†–ú: —Ä–µ—Å—Ç–∞—Ä—Ç ‚Üí impossible ‚Üí —Ñ–µ—Ä–º–µ—Ä ‚Üí –∂–¥–∞—Ç—å –ø—Ä–æ–∏–≥—Ä—ã—à–∞

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui")
local entityFolder = workspace:WaitForChild("Map"):WaitForChild("Entities")
local cash = player:WaitForChild("leaderstats"):WaitForChild("Cash")

local restarting = false

-- üí∞ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–∏ –¥–µ–Ω–µ–≥
local function parseCash(val)
    if not val then return 0 end
    val = tostring(val):gsub(",", "")
    if val:lower():find("k") then
        return tonumber(val:lower():gsub("k", "")) * 1000
    end
    return tonumber(val) or 0
end

-- üí∞ –ñ–¥–∞—Ç—å –±–∞–ª–∞–Ω—Å
local function waitForCash(amount)
    repeat wait(0.2) until parseCash(cash.Value) >= amount or restarting
end

-- üì¶ –°—Ç–∞–≤–∏–º —é–Ω–∏—Ç–∞ –∏ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ ID
local function placeUnitAndGetId(unitName, position)
    local before = {}
    for _, v in pairs(entityFolder:GetChildren()) do before[v] = true end

    local cf = CFrame.new(position) * CFrame.Angles(0, math.rad(180), 0)
    ReplicatedStorage.RemoteFunctions.PlaceUnit:InvokeServer(unitName, {
        Valid = true,
        Position = position,
        CF = cf,
        Rotation = 180
    })

    for _ = 1, 50 do
        wait(0.1)
        for _, v in pairs(entityFolder:GetChildren()) do
            if not before[v] and v:IsA("Model") and v:GetAttribute("ID") then
                print("‚úÖ –ü–æ—Å—Ç–∞–≤–ª–µ–Ω —é–Ω–∏—Ç:", unitName)
                return v:GetAttribute("ID")
            end
        end
    end
    warn("‚ùå –Æ–Ω–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω:", unitName)
    return nil
end

-- üì¶ –ë–µ–∑ –∞–ø–≥—Ä–µ–π–¥–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º, –∫–æ–≥–¥–∞ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥
local function safePlaceOnly(unitName, position, cost)
    waitForCash(cost)
    if restarting then return end
    placeUnitAndGetId(unitName, position)
end

-- üß† –ì–æ–ª–æ—Å—É–µ–º –∑–∞ Impossible
local function autoVoteImpossible()
    task.spawn(function()
        while true do
            wait(0.1)
            local voteUI = gui:FindFirstChild("GameGui")
                and gui.GameGui.Screen
                and gui.GameGui.Screen.Middle
                and gui.GameGui.Screen.Middle:FindFirstChild("DifficultyVote")

            if voteUI and voteUI.Visible then
                ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer("dif_impossible")
                print("üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å Impossible –≤—ã–±—Ä–∞–Ω–∞")
                break
            end
        end
    end)
end

-- üîÅ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
task.spawn(function()
    while true do
        wait(0.3)
        local btn = gui:FindFirstChild("GameGui")
            and gui.GameGui.Screen
            and gui.GameGui.Screen.Middle
            and gui.GameGui.Screen.Middle:FindFirstChild("GameEnd")
            and gui.GameGui.Screen.Middle.GameEnd.Items
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items:FindFirstChild("Again")

        if btn and btn.Visible then
            restarting = true
            print("üîÅ Play Again ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫...")
            ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
        end
    end
end)

-- üîÑ –†–∞—É–Ω–¥
local function runSimpleLoop()
    print("üöÄ –ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫")
    wait(0.5)
    ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
    autoVoteImpossible()
    restarting = false

    -- –°—Ç–∞–≤–∏–º —Ñ–µ—Ä–º–µ—Ä–∞ –ø–æ —Å—Ç–∞—Ä–æ–π —Ä–∞–±–æ—á–µ–π —Å—Ö–µ–º–µ
    safePlaceOnly("unit_farmer_npc", Vector3.new(-332.14, 63.38, -77.40), 200)

    -- –ñ–¥—ë–º —Ä–µ—Å—Ç–∞—Ä—Ç–∞
    while not restarting do wait(0.5) end
end

-- üöÄ –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª
while true do
    runSimpleLoop()
end
