-- üîÅ –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∞–≤—Ç–æ–ª–æ–æ–ø: —Ä–µ—Å—Ç–∞—Ä—Ç ‚Üí —Å–ª–æ–∂–Ω–æ—Å—Ç—å ‚Üí —Ñ–µ—Ä–º–µ—Ä ‚Üí –ø—Ä–æ–∏–≥—Ä—ã—à ‚Üí —Ä–µ—Å—Ç–∞—Ä—Ç

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local gui = player:WaitForChild("PlayerGui")

local restarting = false
local entityFolder = nil

-- üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —é–Ω–∏—Ç–∞
local function placeUnitAndGetId(unitName, position)
    if not entityFolder then
        entityFolder = workspace:WaitForChild("Map"):WaitForChild("Entities")
    end

    local before = {}
    for _, v in pairs(entityFolder:GetChildren()) do before[v] = true end

    local cf = CFrame.new(position) * CFrame.Angles(0, math.rad(180), 0)
    ReplicatedStorage.RemoteFunctions.PlaceUnit:InvokeServer(unitName, {
        Valid = true,
        Position = position,
        CF = cf,
        Rotation = 180
    })

    for _ = 1, 50 do
        task.wait(0.1)
        for _, v in pairs(entityFolder:GetChildren()) do
            if not before[v] and v:IsA("Model") and v:GetAttribute("ID") then
                print("‚úÖ –Æ–Ω–∏—Ç –ø–æ—Å—Ç–∞–≤–ª–µ–Ω:", unitName)
                return v:GetAttribute("ID")
            end
        end
    end
    warn("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å —é–Ω–∏—Ç–∞:", unitName)
end

-- üß† –ê–≤—Ç–æ–≤—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ Impossible
local function voteImpossible()
    task.spawn(function()
        while true do
            task.wait(0.1)
            local voteUI = gui:FindFirstChild("GameGui")
                and gui.GameGui:FindFirstChild("Screen")
                and gui.GameGui.Screen:FindFirstChild("Middle")
                and gui.GameGui.Screen.Middle:FindFirstChild("DifficultyVote")

            if voteUI and voteUI.Visible then
                ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer("dif_impossible")
                print("üéØ –°–ª–æ–∂–Ω–æ—Å—Ç—å Impossible –≤—ã–±—Ä–∞–Ω–∞")
                break
            end
        end
    end)
end

-- üîÅ –ú–æ–Ω–∏—Ç–æ—Ä–∏–º –∫–Ω–æ–ø–∫—É Play Again
task.spawn(function()
    while true do
        wait(0.2)
        local btn = gui:FindFirstChild("GameGui")
            and gui.GameGui.Screen
            and gui.GameGui.Screen.Middle
            and gui.GameGui.Screen.Middle:FindFirstChild("GameEnd")
            and gui.GameGui.Screen.Middle.GameEnd.Items
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items:FindFirstChild("Again")

        if btn and btn.Visible then
            restarting = true
            print("üîÅ Play Again –Ω–∞–π–¥–µ–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ—Å—Ç–∞—Ä—Ç")
            ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
        end
    end
end)

-- üîÅ –ö–∞—Ç–∫–∞
local function runMatch()
    print("üöÄ –ù–æ–≤—ã–π –∑–∞–ø—É—Å–∫ runMatch()")
    task.wait(0.2)
    ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
    voteImpossible()
    restarting = false

    -- –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Ñ–µ—Ä–º–µ—Ä–∞ (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏)
    wait(3) -- ‚Üê –°–Æ–î–ê –º–æ–∂–Ω–æ –ø–æ–¥–±–∏—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ (2‚Äì4 —Å–µ–∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ)
    if restarting then return end

    -- –ü–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ–µ—Ä–º–µ—Ä–∞
    placeUnitAndGetId("unit_farmer_npc", Vector3.new(-332.14, 63.38, -77.40))

    -- –ñ–¥—ë–º –ø—Ä–æ–∏–≥—Ä—ã—à–∞ (—Ä–µ—Å—Ç–∞—Ä—Ç–∞)
    while not restarting do task.wait(0.5) end
end

-- üöÄ –¶–ò–ö–õ
while true do
    runMatch()
end
