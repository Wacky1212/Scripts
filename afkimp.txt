-- üîÅ –ü–†–û–°–¢–û–ô –¶–ò–ö–õ: Restart ‚Üí Impossible ‚Üí –§–µ—Ä–º–µ—Ä ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–æ–∏–≥—Ä—ã—à–∞

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local cash = player:WaitForChild("leaderstats"):WaitForChild("Cash")
local entityFolder = workspace:WaitForChild("Map"):WaitForChild("Entities")

local restarting = false

-- üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —é–Ω–∏—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ ID
local function placeUnitAndGetId(unitName, position)
    local before = {}
    for _, v in pairs(entityFolder:GetChildren()) do before[v] = true end

    local cf = CFrame.new(position) * CFrame.Angles(0, math.rad(180), 0)
    ReplicatedStorage.RemoteFunctions.PlaceUnit:InvokeServer(unitName, {
        Valid = true,
        Position = position,
        CF = cf,
        Rotation = 180
    })

    for _ = 1, 50 do
        wait(0.05)
        for _, v in pairs(entityFolder:GetChildren()) do
            if not before[v] and v:IsA("Model") and v:GetAttribute("ID") then
                print("‚úÖ –§–µ—Ä–º–µ—Ä –ø–æ—Å—Ç–∞–≤–ª–µ–Ω")
                return v:GetAttribute("ID")
            end
        end
    end
    warn("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç–∞–≤–∏—Ç—å —é–Ω–∏—Ç–∞")
    return nil
end

-- üß† –ë—ã—Å—Ç—Ä–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç—å
local function voteImpossible()
    local gui = player:WaitForChild("PlayerGui")

    task.spawn(function()
        while true do
            wait(0.1)
            local voteUI = gui:FindFirstChild("GameGui")
                and gui.GameGui:FindFirstChild("Screen")
                and gui.GameGui.Screen:FindFirstChild("Middle")
                and gui.GameGui.Screen.Middle:FindFirstChild("DifficultyVote")

            if voteUI and voteUI.Visible then
                ReplicatedStorage.RemoteFunctions.PlaceDifficultyVote:InvokeServer("dif_impossible")
                print("üéØ –ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–Ω–æ: Impossible")
                break
            end
        end
    end)
end

-- üîÅ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
task.spawn(function()
    local gui = player:WaitForChild("PlayerGui")
    while true do
        wait(0.2)
        local btn = gui:FindFirstChild("GameGui")
            and gui.GameGui:FindFirstChild("Screen")
            and gui.GameGui.Screen:FindFirstChild("Middle")
            and gui.GameGui.Screen.Middle:FindFirstChild("GameEnd")
            and gui.GameGui.Screen.Middle.GameEnd:FindFirstChild("Items")
            and gui.GameGui.Screen.Middle.GameEnd.Items:FindFirstChild("Frame")
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame:FindFirstChild("Actions")
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions:FindFirstChild("Items")
            and gui.GameGui.Screen.Middle.GameEnd.Items.Frame.Actions.Items:FindFirstChild("Again")

        if btn and btn.Visible then
            restarting = true
            print("üîÅ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ Play Again ‚Äî —Ä–µ—Å—Ç–∞—Ä—Ç...")
            ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
        end
    end
end)

-- üîÅ –û–¥–∏–Ω —Ü–∏–∫–ª
local function runSimpleMatch()
    print("üöÄ –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥...")
    wait(0.5)
    ReplicatedStorage.RemoteFunctions.RestartGame:InvokeServer()
    voteImpossible()
    wait(0.5)

    restarting = false

    -- –°—Ç–∞–≤–∏–º —Ñ–µ—Ä–º–µ—Ä–∞
    placeUnitAndGetId("unit_farmer_npc", Vector3.new(-332.14, 63.38, -77.40))

    -- –û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
    while not restarting do wait(0.5) end
end

-- üöÄ –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
while true do
    runSimpleMatch()
end
